# AiTi Guru

---
### Задание 1 - Спроектировать схему БД (Модель данных реляционная)
#### (результатом выполнения задания должна быть даталогическая схема данных)

---
### Сущности

---
#### 1.1. Номенклатура (товары) (наименование, кол-во, цена)
##### Вариант решения :
```text
|-----------------------------------------|
|                 products                |
|-----------------------------------------|
| PK id        : INT                      |
| name         : VARCHAR(255)             |
| quantity     : INT                      |
| price        : DECIMAL(11,2)            |
| category_id  : INT (FK → categories.id) |
|-----------------------------------------|
```
##### Пример заполнения :
```text
| id | name     | quantity | price  | category_id |
|----|----------|----------|--------|-------------|
| 1  | SONY TV  | 10       | 500.00 | 6           |
| 2  | BOSCH WM | 5        | 799.99 | 2           |
```
---
#### 1.2. Каталог номенклатуры/Дерево категорий.
Необходимо хранить данные о категориях товара, при этом сами категории могут иметь неограниченный уровень вложенности
На этапе проектирования максимальный уровень вложенности неизвестен.

Пример дерева категорий:

	Бытовая техника
		Стиральные машины
		Холодильники
			однокамерные
			двухкамерные
		Телевизоры
		...
	Компьютеры
		Ноутбуки
			17"
			19"
			...
		Моноблоки
		...
Схема данных категорий номенклатуры должна безболезненно позволять добавлять категории любого уровня вложенности.

##### Вариант решения :

```text
|----------------------------|
|          categories        |
|----------------------------|
| id (PK)      : INT         |
| name         : VARCHAR(255)|
| parent_id    : INT NULL    |
| top_level_id : INT         |
|----------------------------|
```
##### Пример заполнения :
```text
| id | name              | parent_id | top_level_id |
|----|-------------------|-----------|--------------|
|  1 | Бытовая техника   | NULL      | 1            |
|  2 | Стиральные машины | 1         | 1            |
|  3 | Холодильники      | 1         | 1            |
|  4 | Однокамерные      | 3         | 1            |
|  5 | Двухкамерные      | 3         | 1            |
|  6 | Телевизоры        | 1         | 1            |
|  7 | Компьютеры        | NULL      | 1            |
|  8 | Ноутбуки          | 7         | 7            |
|  9 | 17"               | 8         | 7            |
| 10 | 19"               | 8         | 7            |
| 11 | Моноблоки         | 7         | 7            |
```
---
#### 1.3. Клиенты (наименование, адрес)
##### Вариант решения :

```text
|-----------------------------|
|          clients            |
|-----------------------------|
| id (PK) : INT               |
| name    : VARCHAR(255)      |
| address : VARCHAR(255) NULL |
|-----------------------------|
```
##### Пример заполнения :
```text
| id | name          | address                            |
|----|---------------|------------------------------------|
|  1 | ООО "Ромашка" | г. Москва, ул. Ленина, 10          |
|  2 | ИП Петров     | г. Санкт-Петербург, Невский пр., 5 |
|  3 | ООО "Ноль"    | NULL                               |
```
---
#### 1.4. Заказы покупателей.
#### Необходимо предусмотреть возможность делать заказ из разного набора товаров.
#### (продумать схему БД, бизнес логику описывать не требуется)

##### Вариант решения :

```text
|--------------------------------------|
|                orders                |
|--------------------------------------|
| id (PK)      : INT                   |
| client_id    : INT (FK → clients.id) |
| order_date   : DATETIME              |
| status       : VARCHAR(50)           |
| total_amount : DECIMAL(11,2)         |
|--------------------------------------|
 
                    +
                    
|-------------------------------------|
|             order_items             |
|-------------------------------------|
| id (PK)    : INT                    |
| order_id   : INT (FK → orders.id)   | 
| product_id : INT (FK → products.id) |
| quantity   : INT                    |
| price      : DECIMAL(11,2)          |
|-------------------------------------|

```
##### Пример заполнения :
```text
| id | client_id | order_date          | status   | total_amount |
|----|-----------|---------------------|----------|--------------|
| 1  | 1         | 2025-09-01 10:15:00 | PAID     | 1299.99      |
| 2  | 2         | 2025-09-02 15:40:00 | CANCELED | 500.00       |

                                +
                                
| id | order_id | product_id | quantity | price  |
|----|----------|------------|----------|--------|
| 1  | 1        | 2          | 1        | 799.99 |
| 2  | 1        | 1          | 1        | 500.00 |
| 3  | 2        | 1          | 1        | 500.00 |

```
---
### Задание 2 - Написать следующие SQL запросы:

---
#### 2.1. Получение информации о сумме товаров заказанных под каждого клиента (Наименование клиента, сумма)

```sql
SELECT 
    c.name AS client_name,
    COALESCE(SUM(oi.quantity * oi.price), 0) AS total_amount
FROM clients c
LEFT JOIN orders o ON c.id = o.client_id
LEFT JOIN order_items oi ON o.id = oi.order_id
GROUP BY c.id
ORDER BY total_amount DESC;
```
##### Примерный результат :
```text
| client_name   | total_amount  |
| ------------- | ------------- |
| ООО "Ромашка" | 1299.99       |
| ИП Петров     | 500.00        |
| ООО "Ноль"    | 0.00          |
```
---
#### 2.2. Найти количество дочерних элементов первого уровня вложенности для категорий номенклатуры.
```sql
SELECT 
    parent.name AS parent_category,
    COUNT(child.id) AS first_level_children_count
FROM categories parent
LEFT JOIN categories child ON child.parent_id = parent.id
GROUP BY parent.id
ORDER BY parent.name;
```
##### Примерный результат :
```text
| parent_category   | first_level_children_count |
|-------------------|----------------------------|
| Бытовая техника   | 3                          | -- Стиральные машины, Холодильники, Телевизоры
| Стиральные машины | 0                          | 
| Холодильники      | 2                          | -- Однокамерные, Двухкамерные
| Однокамерные      | 0                          | 
| Двухкамерные      | 0                          | 
| Телевизоры        | 0                          | 
| Компьютеры        | 2                          | -- Ноутбуки, Моноблоки
| Ноутбуки          | 2                          | -- 17", 19"
| 17"               | 0                          |
| 19"               | 0                          |
| Моноблоки         | 0                          |
```
---
#### 2.3.1. Написать текст запроса для отчета (view) «Топ-5 самых покупаемых товаров за последний месяц» (по количеству штук в заказах). В отчете должны быть: Наименование товара, Категория 1-го уровня, Общее количество проданных штук.
```sql
CREATE OR REPLACE VIEW top_5_products_last_month AS
SELECT 
    p.name AS product_name,
    c_top.id AS top_level_category_id,
    SUM(oi.quantity) AS total_quantity_sold
FROM order_items oi
JOIN orders o ON oi.order_id = o.id
JOIN products p ON oi.product_id = p.id
JOIN categories c ON p.category_id = c.id
JOIN categories c_top ON c.top_level_id = c_top.id
WHERE o.order_date >= NOW() - INTERVAL '1 month'
GROUP BY p.id, c_top.id
ORDER BY total_quantity_sold DESC
LIMIT 5;
```
##### Примерный результат :
```text
| product_name   | top_level_category   | total_quantity_sold |
|----------------|----------------------|---------------------|
| SONY TV        | Бытовая техника      | 12                  |
| BOSCH WM       | Бытовая техника      | 10                  |
| HP Laptop      | Компьютеры           | 8                   |
| Samsung Fridge | Бытовая техника      | 7                   |
| Apple Mac Pro  | Компьютеры           | 5                   |
```
---
#### 2.3.2. Проанализировать написанный в п. 2.3.1 запрос и структуру БД. Предложить варианты оптимизации этого запроса и общей схемы данных для повышения производительности системы в условиях роста данных (тысячи заказов в день).

1. Использование индексов
 - На orders(order_date) → ускоряет фильтрацию последних заказов по дате (без сканирования всей таблицы orders).
 - На order_items(order_id, product_id) → ускоряет соединение и агрегацию (таблицу order_items с orders и products).
 - На products(category_id) → Ускоряет определение категории товара.
2. Материализованные представления (MATERIALIZED VIEW)
3. Агрегированные таблицы (где хранятся ежедневные суммарные продажи товаров - гораздо меньше данных, чем сканировать все order_items)
```sql
| date       | product_id | total_quantity |
|------------|------------|----------------|
| 2025-09-01 | 1          | 10             |
| 2025-09-01 | 2          | 5              |
```
4. топ-5 товаров за месяц можно хранить в кэше для быстрого доступа (Redis) и обновлять раз в час/день.
---

### Задание 3 - сервис «Добавление товара в заказ»

---
Написать сервис «Добавление товара в заказ» который работает по REST-API. Метод должен принимать ID заказа, ID номенклатуры и количество. Если товар уже есть в заказе, его количество должно увеличиваться, а не создаваться новая позиция. Если товара нет в наличии то должна возвращаться соответствующая ошибка. Стек -  любой фреймворк в пределах Python. Git репозиторий, контейнеризация, документация, и прочее — приветствуется.

Пример дерева категорий:
```text
|----------------------------
| Бытовая техника       | 3 |
|    Стиральные машины  | 0 |
|    Холодильники       | 2 |
|       однокамерные    | 0 |
|       двухкамерные	| 0 |
|    Телевизоры         | 0 |
| Компьютеры            | 2 |
|    Ноутбуки           | 2 |
|       17"             | 0 |
|       19"             | 0 |
|    моноблоки          | 0 |
-----------------------------
```

---
### Запуск

---

#### Основное приложение (FastAPI) запускается командой:
```bash
python main.py
```
(внутри запускается uvicorn, порт 8000)

---
#### Базовое тестирование сервиса запускается командой:
```bash
python test_service.py
```
(будет заменено на pytest)

---
#### Запуск через Docker compose :
```bash
docker-compose up --build
```
---

### Пример запроса

#### POST /
```bash
curl -X POST http://localhost:8000/orders/1/add-product?product_id=2&quantity=3
```

---
#### Инструменты, использованные при решении задачи

- Python, FastAPI, PostgreSQL

---